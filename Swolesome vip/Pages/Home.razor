@page "/"
@using System.Collections
@using System.Globalization;
@using System.Net
@using System.Text
@using System.Text.Json
@using Swolesome_vip.Models;
@using CsvHelper;
@using Swolesome_vip.Utils
@inject IJSRuntime JS

<section class="bg-white rounded shadow p-4 mb-4">
    <SearchInterface OnSearchCompleted="HandleSearchCompleted" />
</section>

@if (Results is not null && Results.Count > 0)
{
    <hr />
    @foreach (var result in Results)
    {
        var rows = result.JsonData
            .Select(item => new SearchResult
            {
                Data = item.EnumerateObject().ToDictionary(p => p.Name, p => (object)p.Value),
                ChildrenMap = new Dictionary<string, List
                    <SearchResult>>(),
                ExpandedKeys = new HashSet
                    <string>()
            })
            .ToList();
        <section class="bg-white rounded shadow p-4 mb-4">
            <div class="d-flex justify-content-between mb-2">
                <h5 class="fw-bold text-black-50">
                    Results for
                    <span class="text-primary">@String.Join(", ", result.SelectedFields): @result.Term</span>
                </h5>

                <div class="d-flex align-items-center gap-2 mb-2">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ExportResult(result, 3, rows)">Download as text</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ExportResult(result, 1, rows)">Download as CSV</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ExportResult(result, 0, rows)">Download as JSON</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ExportResult(result, 2, rows)">Download as HTML</button>
                </div>
            </div>
            
            @if (result.JsonData is null || !result.JsonData.Any())
            {
                <p class="text-muted">No results found.</p>
            }
            else if (result.JsonData.Count == 1 && result.JsonData[0].TryGetProperty("error", out var errorProp))
            {
                <p class="text-danger fw-bold">Error: @errorProp.GetString()</p>
            }
            else
            {
                <ResultsTable Rows="rows"/>
            }
        </section>
    }
}

@code {
    [Parameter] public List<SearchResult> Results { get; set; } = new List<SearchResult>();

    private void HandleSearchCompleted(List<SearchResult> ctx)
    {
        Results = ctx;
    }
    
    private List<Dictionary<string, object>> FlattenExpanded(List<SearchResult> rows)
    {
        var list = new List<Dictionary<string, object>>();

        foreach (var row in rows)
        {
            list.Add(row.Data.ToDictionary(k => k.Key, k => k.Value));

            foreach (var key in row.ExpandedKeys)
            {
                if (row.ChildrenMap.TryGetValue(key, out var children))
                    list.AddRange(FlattenExpanded(children));
            }
        }

        return list;
    }

    private async Task ExportResult(SearchResult result, int format, List<SearchResult> rows)
    {
        if (rows == null || rows.Count == 0) return;

        var exportRows = FlattenExpanded(rows);

        string extension = format switch { 0 => "json", 1 => "csv", 2 => "html", 3 => "txt", _ => "txt" };
        string content = format switch
        {
            0 => JsonSerializer.Serialize(exportRows, new JsonSerializerOptions { WriteIndented = true }),
            1 => ToCsv(exportRows),
            2 => ToHtml(exportRows),
            3 => ToText(exportRows),
            _ => string.Empty
        };

        var safeTerm = string.Join("_", result.Term.Split(Path.GetInvalidFileNameChars(), StringSplitOptions.RemoveEmptyEntries));
        var fileName = $"swolesome_{safeTerm}_{DateTime.Now:yyyyMMdd_HHmmss}.{extension}";
        await DownloadFileAsync(fileName, content);
    }
    
    private string ToText(List<Dictionary<string, object>> rows)
    {
        var sb = new StringBuilder();
        foreach (var row in rows)
        {
            foreach (var kv in row)
                sb.AppendLine($"{kv.Key}: {kv.Value}");
            sb.AppendLine(new string('-', 60));
        }
        return sb.ToString();
    }

    private string ToCsv(List<Dictionary<string, object>> rows)
    {
        if (!rows.Any()) return string.Empty;

        var headers = rows.SelectMany(r => r.Keys).Distinct().ToList();

        using var sw = new StringWriter();
        using (var csv = new CsvWriter(sw, CultureInfo.InvariantCulture))
        {
            foreach (var h in headers) csv.WriteField(h);
            csv.NextRecord();

            foreach (var row in rows)
            {
                foreach (var h in headers)
                    csv.WriteField(row.TryGetValue(h, out var val) ? val : "");
                csv.NextRecord();
            }
        }

        return sw.ToString();
    }

    private string ToHtml(List<Dictionary<string, object>> rows)
    {
        var sb = new StringBuilder();

        foreach (var row in rows)
        {
            sb.Append("<table style=\"border-collapse:collapse;width:100%;margin-bottom:10px;table-layout:auto;\">");
            foreach (var kv in row)
            {
                sb.Append("<tr>")
                    .Append("<td style=\"width:30%;padding:6px;font-weight:bold;border:1px solid #ccc;\">")
                    .Append(WebUtility.HtmlEncode(kv.Key))
                    .Append("</td>")
                    .Append("<td style=\"padding:6px;border:1px solid #ccc;\">")
                    .Append(WebUtility.HtmlEncode(kv.Value?.ToString() ?? ""))
                    .Append("</td></tr>");
            }
            sb.Append("</table>");
        }

        return sb.ToString();
    }

    private async Task DownloadFileAsync(string fileName, string content)
    {
        var bytes = Encoding.UTF8.GetBytes(content);
        using var streamRef = new Microsoft.JSInterop.DotNetStreamReference(new MemoryStream(bytes));
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}
